<div class="bg-white rounded-lg p-8 shadow-sm mb-8">
  <h2 class="text-2xl font-medium mb-6">Create new plan</h2>
  
  <form [formGroup]="form" (ngSubmit)="handleSubmit()">
    <div class="mb-6">
      <label for="name" class="block text-gray-700 mb-2">Plan name <span class="text-purple-main">*</span></label>
      <input
        type="text"
        id="name"
        formControlName="name"
        placeholder="Name"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
        [ngClass]="{
          'ng-touched ng-dirty border-red-500': isSubmitted && name.invalid
        }"
      />
      @if (isSubmitted && name.invalid) {
      <ca-form-error [errors]="name.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="desc" class="block text-gray-700 mb-2">Short description <span class="text-purple-main">*</span></label>
      <input
        type="text"
        id="desc"
        formControlName="desc"
        placeholder="Short description"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
        [ngClass]="{
          'ng-touched ng-dirty border-red-500': isSubmitted && desc.invalid
        }"
      />
      @if (isSubmitted && desc.invalid) {
      <ca-form-error [errors]="desc.errors" />
      }
    </div>

    <!-- Public description field - only shown when creating a public MGR -->
    @if (isPublicMgr) {
    <div class="mb-6">
      <label for="public-desc" class="block text-gray-700 mb-2 font-medium">Public description <span class="text-purple-main">*</span></label>
      <div class="text-sm text-gray-600 mb-2">This description will be visible to all Collo Africa users. Required for public MGRs.</div>
      <textarea
        id="public-desc"
        [(ngModel)]="publicDescription"
        [ngModelOptions]="{standalone: true}"
        placeholder="Detailed description visible to the public"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main h-24"
        [ngClass]="{
          'ng-touched ng-dirty border-red-500': isSubmitted && !publicDescription
        }"
        (focus)="publicDescription = publicDescription || 'Join our MGR plan to save together and achieve financial goals!'"
      ></textarea>
      @if (isSubmitted && !publicDescription) {
      <div class="text-red-500 text-sm mt-1">Public description is required for public MGRs</div>
      }
    </div>
    }

    <div class="mb-6">
      <label for="duration" class="block text-gray-700 mb-2">Duration <span class="text-purple-main">*</span></label>
      <div class="relative">
        <ng-select
          id="duration"
          formControlName="duration"
          [clearOnBackspace]="false"
          placeholder="Select duration"
          class="py-1 border border-gray-300 rounded-lg"
          [ngClass]="{
            'ng-touched ng-dirty border-red-500': isSubmitted && duration.invalid
          }"
        >
          @for (duration of durations; track $index) {
          <ng-option [value]="duration.id">{{ duration.name }}</ng-option>
          }
        </ng-select>
      </div>
      @if (isSubmitted && duration.invalid) {
      <ca-form-error [errors]="duration.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="num-members" class="block text-gray-700 mb-2">Number of members <span class="text-purple-main">*</span></label>
      <input
        type="number"
        id="num-members"
        formControlName="number_of_members"
        placeholder="Number of members"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
        [ngClass]="{
          'ng-touched ng-dirty border-red-500': isSubmitted && numberOfMembers.invalid
        }"
      />
      @if (isSubmitted && numberOfMembers.invalid) {
      <ca-form-error [errors]="numberOfMembers.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="amount" class="block text-gray-700 mb-2">Amount <span class="text-purple-main">*</span></label>
      <input
        type="text"
        id="amount"
        formControlName="amount"
        placeholder="Enter amount"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
        [ngClass]="{
          'ng-touched ng-dirty border-red-500': isSubmitted && amount.invalid
        }"
      />
      @if (isSubmitted && amount.invalid) {
      <ca-form-error [errors]="amount.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="date" class="block text-gray-700 mb-2">Contribution Start Date <span class="text-purple-main">*</span></label>
      <div class="relative">
        <input
          id="date"
          type="text"
          formControlName="contribution_start_date"
          placeholder="18-05-2023"
          bsDatepicker
          #cdp="bsDatepicker"
          [minDate]="minContributionDate"
          [bsConfig]="{ isAnimated: true, dateInputFormat: 'DD-MM-YYYY' }"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
          [ngClass]="{
            'ng-dirty ng-touched border-red-500': isSubmitted && startDate.invalid
          }"
        />
        <button type="button" (click)="cdp.show()" class="absolute right-3 top-1/2 transform -translate-y-1/2">
          <i class="ca-calendar text-[#5c5c5c]"></i>
        </button>
      </div>
      @if (isSubmitted && startDate.invalid) {
      <ca-form-error [errors]="startDate.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="allocation-date" class="block text-gray-700 mb-2">Allocation Date <span class="text-purple-main">*</span></label>
      <div class="relative">
        <input
          id="allocation-date"
          type="text"
          formControlName="allocation_date"
          placeholder="18-05-2023"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-main"
          [ngClass]="{
            'ng-dirty ng-touched border-red-500': isSubmitted && allocationDate.invalid
          }"
        />
        <span class="absolute right-3 top-1/2 transform -translate-y-1/2">
          <i class="ca-calendar text-[#5c5c5c]"></i>
        </span>
      </div>
      @if (isSubmitted && allocationDate.invalid) {
      <ca-form-error [errors]="allocationDate.errors" />
      }
    </div>

    <div class="mb-6">
      <label for="allotment-type" class="block text-gray-700 mb-2">Allotment Type <span class="text-purple-main">*</span></label>
      <div class="relative">
        <!-- Use buttons instead of ng-select for more reliable selection -->
        <div class="flex gap-3 mb-2">
          <button 
            type="button" 
            class="px-4 py-2 border rounded-lg" 
            [class.bg-purple-main]="selectedAllotmentType === 'manual'" 
            [class.text-white]="selectedAllotmentType === 'manual'" 
            [class.border-purple-main]="selectedAllotmentType === 'manual'" 
            [class.border-gray-300]="selectedAllotmentType !== 'manual'" 
            (click)="selectedAllotmentType = 'manual'; allotmentType.setValue('manual')"
          >
            Manual
          </button>
          <button 
            type="button" 
            class="px-4 py-2 border rounded-lg" 
            [class.bg-purple-main]="selectedAllotmentType === 'auto'" 
            [class.text-white]="selectedAllotmentType === 'auto'" 
            [class.border-purple-main]="selectedAllotmentType === 'auto'" 
            [class.border-gray-300]="selectedAllotmentType !== 'auto'" 
            (click)="selectedAllotmentType = 'auto'; allotmentType.setValue('auto')"
          >
            Automatic
          </button>
        </div>
        
        <!-- Hidden input for form validation -->
        <input type="hidden" formControlName="allotment_type">
      </div>
      @if (isSubmitted && allotmentType.invalid) {
      <div class="text-red-500 text-sm mt-1">Please select an allotment type</div>
      }
    </div>
    
    <!-- Only shown if allotment type is selected -->
    @if (selectedAllotmentType) {
    <div class="mb-6">
      <ca-allotment-type-card
        [allotmentType]="selectedAllotmentType"
        (allotmentTypeChange)="selectAllotmentType()"
      />
    </div>
    }

    <div class="mb-6">
      <div class="flex items-start gap-3">
        <input 
          type="checkbox" 
          id="public-mgr" 
          [(ngModel)]="isPublicMgr" 
          [ngModelOptions]="{standalone: true}" 
          (ngModelChange)="updateAllotmentTypeForPublicMgr()" 
          class="mt-1" 
        />
        <label class="text-sm text-gray-700" for="public-mgr">
          Make this MGR plan public (visible to all Collo Africa users)
        </label>
      </div>
    </div>

    <div class="mb-12">
      <div class="flex items-start gap-3">
        <input type="checkbox" id="subscribe" [formControl]="terms" class="mt-1" />
        <label class="text-sm text-gray-700" for="subscribe">
          I agree to Collo Africa MGR terms and conditions.
        </label>
      </div>
      @if (isSubmitted && terms.invalid) {
      <ca-form-error [errors]="terms.errors" />
      }
    </div>

    <div class="mb-4">
      <button
        class="w-full py-3 bg-purple-main text-white rounded-lg font-medium"
        type="submit"
        [disabled]="loading"
      >
        {{ loading ? 'Processing...' : 'Create plan' }}
      </button>
    </div>
  </form>
</div>
