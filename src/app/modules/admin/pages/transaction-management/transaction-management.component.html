<!-- Transaction Management Page -->
<div class="transaction-management-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1>Transaction Management</h1>
        <p class="header-subtitle">Monitor, analyze, and manage all platform transactions with comprehensive oversight tools</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="exportAllTransactions()">
          <i class="icon-download"></i> Export CSV
        </button>
        <button class="btn btn-primary" (click)="exportAsExcel()">
          <i class="icon-excel"></i> Export Excel
        </button>
      </div>
    </div>
  </div>

  <!-- Analytics Dashboard -->
  <div class="analytics-section" *ngIf="analytics">
    <div class="analytics-grid">
      <!-- Key Metrics -->
      <div class="metric-card">
        <div class="metric-header">
          <h3>Total Volume</h3>
          <i class="icon-volume"></i>
        </div>
        <div class="metric-value">{{ formatCurrency(analytics.totalVolume) }}</div>
        <div class="metric-change positive">
          <i class="icon-trend-up"></i> +12.5% from last month
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Total Revenue</h3>
          <i class="icon-revenue"></i>
        </div>
        <div class="metric-value">{{ formatCurrency(analytics.totalRevenue) }}</div>
        <div class="metric-change positive">
          <i class="icon-trend-up"></i> +8.3% from last month
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Transaction Count</h3>
          <i class="icon-count"></i>
        </div>
        <div class="metric-value">{{ analytics.transactionCount | number }}</div>
        <div class="metric-change positive">
          <i class="icon-trend-up"></i> +15.2% from last month
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Success Rate</h3>
          <i class="icon-success"></i>
        </div>
        <div class="metric-value">{{ analytics.successRate }}%</div>
        <div class="metric-change negative">
          <i class="icon-trend-down"></i> -1.2% from last month
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Average Transaction</h3>
          <i class="icon-average"></i>
        </div>
        <div class="metric-value">{{ formatCurrency(analytics.averageTransactionSize) }}</div>
        <div class="metric-change positive">
          <i class="icon-trend-up"></i> +3.7% from last month
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Flagged Transactions</h3>
          <i class="icon-flag"></i>
        </div>
        <div class="metric-value">{{ analytics.riskMetrics.flaggedTransactions }}</div>
        <div class="metric-change negative">
          <i class="icon-trend-up"></i> +23 from last month
        </div>
      </div>
    </div>

    <!-- Payment Methods Performance -->
    <div class="payment-methods-section">
      <h3>Payment Methods Performance</h3>
      <div class="payment-methods-grid">
        <div class="payment-method-card" *ngFor="let method of analytics.topPaymentMethods">
          <div class="method-header">
            <h4>{{ method.method }}</h4>
            <span class="success-rate" [class.high]="method.successRate >= 95" [class.medium]="method.successRate >= 90 && method.successRate < 95" [class.low]="method.successRate < 90">
              {{ method.successRate }}%
            </span>
          </div>
          <div class="method-stats">
            <div class="stat-item">
              <span class="stat-label">Volume</span>
              <span class="stat-value">{{ formatCurrency(method.volume) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Transactions</span>
              <span class="stat-value">{{ method.count | number }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-row">
      <!-- Search -->
      <div class="filter-group">
        <label>Search Transactions</label>
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="filters.search" 
            (input)="onSearchChange()"
            placeholder="Search by reference, user, or description"
            class="form-control">
          <i class="icon-search"></i>
        </div>
      </div>

      <!-- Type Filter -->
      <div class="filter-group">
        <label>Transaction Type</label>
        <select [(ngModel)]="filters.type" (change)="onFilterChange()" class="form-control">
          <option *ngFor="let option of typeOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="filters.status" (change)="onFilterChange()" class="form-control">
          <option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Payment Method Filter -->
      <div class="filter-group">
        <label>Payment Method</label>
        <select [(ngModel)]="filters.paymentMethod" (change)="onFilterChange()" class="form-control">
          <option *ngFor="let option of paymentMethodOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
    </div>

    <div class="filters-row">
      <!-- Amount Range -->
      <div class="filter-group">
        <label>Amount Range (NGN)</label>
        <div class="range-inputs">
          <input 
            type="number" 
            [(ngModel)]="filters.amountRange!.min" 
            (change)="onFilterChange()"
            placeholder="Min Amount" 
            class="form-control"
            min="0">
          <span>to</span>
          <input 
            type="number" 
            [(ngModel)]="filters.amountRange!.max" 
            (change)="onFilterChange()"
            placeholder="Max Amount" 
            class="form-control"
            min="0">
        </div>
      </div>

      <!-- Risk Level Filter -->
      <div class="filter-group">
        <label>Risk Level</label>
        <select [(ngModel)]="filters.riskLevel" (change)="onFilterChange()" class="form-control">
          <option *ngFor="let option of riskLevelOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Sort Options -->
      <div class="filter-group">
        <label>Sort By</label>
        <div class="sort-controls">
          <select [(ngModel)]="filters.sortBy" (change)="onSortChange()" class="form-control">
            <option *ngFor="let option of sortOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
          <button 
            class="btn btn-secondary sort-direction" 
            (click)="filters.sortOrder = filters.sortOrder === 'asc' ? 'desc' : 'asc'; onSortChange()">
            <i [class]="'icon-arrow-' + (filters.sortOrder === 'asc' ? 'up' : 'down')"></i>
          </button>
        </div>
      </div>

      <!-- Clear Filters -->
      <div class="filter-group">
        <label>&nbsp;</label>
        <button class="btn btn-outline" (click)="clearFilters()">
          <i class="icon-refresh"></i> Clear Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Actions Bar -->
  <div class="quick-actions-bar" *ngIf="selectedTransactions.size > 0">
    <div class="selected-info">
      <span>{{ selectedTransactions.size }} transaction(s) selected</span>
    </div>
    <div class="quick-actions">
      <button 
        *ngFor="let action of quickActions"
        class="btn"
        [ngClass]="action.class"
        (click)="executeQuickAction(action.value)">
        {{ action.label }}
      </button>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="transactions-table-container">
    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner"></div>
      <p>Loading transactions...</p>
    </div>

    <!-- Table -->
    <div class="table-responsive" *ngIf="!loading">
      <table class="transactions-table">
        <thead>
          <tr>
            <th class="checkbox-col">
              <input 
                type="checkbox" 
                [checked]="allTransactionsSelected"
                [indeterminate]="someTransactionsSelected"
                (change)="toggleAllTransactions()">
            </th>
            <th class="reference-col">Reference</th>
            <th class="type-col">Type</th>
            <th class="user-col">User</th>
            <th class="amount-col">Amount</th>
            <th class="status-col">Status</th>
            <th class="payment-col">Payment Method</th>
            <th class="risk-col">Risk Score</th>
            <th class="date-col">Date</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr 
            *ngFor="let transaction of transactions" 
            class="transaction-row"
            [class.selected]="isTransactionSelected(transaction.id)"
            [class.flagged]="transaction.status === 'flagged'"
            (click)="openTransactionDetails(transaction.id)">
            
            <!-- Selection Checkbox -->
            <td class="checkbox-cell" (click)="$event.stopPropagation()">
              <input 
                type="checkbox" 
                [checked]="isTransactionSelected(transaction.id)"
                (change)="toggleTransactionSelection(transaction.id)">
            </td>

            <!-- Reference -->
            <td class="reference-cell">
              <div class="reference-info">
                <span class="reference-text">{{ transaction.reference }}</span>
                <span class="mgr-name" *ngIf="transaction.mgrName">{{ transaction.mgrName }}</span>
              </div>
            </td>

            <!-- Type -->
            <td class="type-cell">
              <div class="type-badge" [ngClass]="getTypeClass(transaction.type)">
                <i [ngClass]="getTypeIcon(transaction.type)"></i>
                <span>{{ transaction.type | titlecase }}</span>
              </div>
            </td>

            <!-- User -->
            <td class="user-cell">
              <div class="user-info">
                <div class="user-name">{{ transaction.userName }}</div>
                <div class="user-email">{{ transaction.userEmail }}</div>
              </div>
            </td>

            <!-- Amount -->
            <td class="amount-cell">
              <div class="amount-info">
                <div class="gross-amount">{{ formatCurrency(transaction.amount) }}</div>
                <div class="net-amount" *ngIf="transaction.fees > 0">
                  Net: {{ formatCurrency(transaction.netAmount) }}
                </div>
                <div class="fees" *ngIf="transaction.fees > 0">
                  Fee: {{ formatCurrency(transaction.fees) }}
                </div>
              </div>
            </td>

            <!-- Status -->
            <td class="status-cell">
              <span class="status-badge" [ngClass]="getStatusClass(transaction.status)">
                {{ transaction.status | titlecase }}
              </span>
              <div class="gateway-response" *ngIf="transaction.gatewayResponse">
                {{ transaction.gatewayResponse }}
              </div>
              <div class="flagged-reason" *ngIf="transaction.flaggedReason">
                {{ transaction.flaggedReason }}
              </div>
            </td>

            <!-- Payment Method -->
            <td class="payment-cell">
              <div class="payment-method">{{ transaction.paymentMethod }}</div>
            </td>

            <!-- Risk Score -->
            <td class="risk-cell">
              <div class="risk-score" [ngClass]="getRiskClass(transaction.riskScore)">
                <span class="score-value">{{ transaction.riskScore }}</span>
                <span class="risk-label">{{ getRiskLabel(transaction.riskScore) }}</span>
              </div>
            </td>

            <!-- Date -->
            <td class="date-cell">
              <div class="date-info">
                <div class="created-date">{{ formatDate(transaction.createdAt) }}</div>
                <div class="completed-date" *ngIf="transaction.completedAt">
                  Completed: {{ formatDate(transaction.completedAt) }}
                </div>
              </div>
            </td>

            <!-- Actions -->
            <td class="actions-cell" (click)="$event.stopPropagation()">
              <div class="action-buttons">
                <button 
                  class="btn btn-sm btn-primary" 
                  (click)="openTransactionDetails(transaction.id)"
                  title="View Details">
                  <i class="icon-eye"></i>
                </button>
                <button 
                  *ngIf="transaction.status === 'flagged'"
                  class="btn btn-sm btn-success" 
                  (click)="quickApprove(transaction.id, $event)"
                  title="Approve Transaction">
                  <i class="icon-check"></i>
                </button>
                <button 
                  *ngIf="transaction.status !== 'flagged' && transaction.status !== 'failed'"
                  class="btn btn-sm btn-warning" 
                  (click)="quickFlag(transaction.id, $event)"
                  title="Flag for Review">
                  <i class="icon-flag"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="transactions.length === 0">
        <div class="empty-icon">
          <i class="icon-transaction"></i>
        </div>
        <h3>No Transactions Found</h3>
        <p>No transactions match your current filters. Try adjusting your search criteria.</p>
        <button class="btn btn-primary" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="transactions.length > 0">
    <div class="pagination-info">
      <span>Showing {{ (currentPage - 1) * filters.perPage! + 1 }} to {{ Math.min(currentPage * filters.perPage!, totalTransactions) }} of {{ totalTransactions }} transactions</span>
    </div>
    
    <div class="pagination-controls">
      <!-- Items per page -->
      <div class="per-page-selector">
        <label>Show:</label>
        <select [(ngModel)]="filters.perPage" (change)="onPerPageChange()" class="form-control">
          <option *ngFor="let option of perPageOptions" [value]="option">{{ option }}</option>
        </select>
        <span>per page</span>
      </div>

      <!-- Page Navigation -->
      <div class="page-navigation">
        <button 
          class="btn btn-secondary" 
          [disabled]="currentPage === 1"
          (click)="onPageChange(currentPage - 1)">
          <i class="icon-chevron-left"></i> Previous
        </button>
        
        <div class="page-numbers">
          <button 
            *ngFor="let page of getPaginationPages()" 
            class="btn"
            [ngClass]="page === currentPage ? 'btn-primary' : 'btn-outline'"
            (click)="onPageChange(page)">
            {{ page }}
          </button>
        </div>
        
        <button 
          class="btn btn-secondary" 
          [disabled]="currentPage === totalPages"
          (click)="onPageChange(currentPage + 1)">
          Next <i class="icon-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Details Modal -->
<!-- <app-transaction-details
  [transactionId]="selectedTransactionId"
  [isOpen]="showTransactionDetails"
  (onClose)="closeTransactionDetails()"
  (onTransactionUpdated)="onTransactionUpdated()">
</app-transaction-details> --> 