<div class="mgr-details-overlay" [class.visible]="isVisible" (click)="onClose()">
  <div class="mgr-details-modal" (click)="$event.stopPropagation()">
    @if (loading) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading MGR details...</p>
      </div>
    } @else if (mgrDetails) {
      <!-- Header -->
      <div class="modal-header">
        <div class="header-content">
          <div class="mgr-title">
            <h2>{{ mgrDetails.name }}</h2>
            <span class="status-badge" [class]="getStatusBadgeClass(mgrDetails.status)">
              {{ mgrDetails.status | titlecase }}
            </span>
          </div>
          <button class="close-button" (click)="onClose()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          @if (mgrDetails.status === 'pending') {
            <button class="btn btn-success" (click)="openStatusModal('active')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Approve
            </button>
            <button class="btn btn-danger" (click)="openStatusModal('rejected')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Reject
            </button>
          }
          @if (mgrDetails.status === 'active') {
            <button class="btn btn-warning" (click)="openStatusModal('suspended')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Suspend
            </button>
          }
          @if (mgrDetails.status === 'suspended') {
            <button class="btn btn-success" (click)="openStatusModal('active')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1"></path>
              </svg>
              Resume
            </button>
          }
          <button class="btn btn-info" (click)="openNoteModal()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Add Note
          </button>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <div class="tabs-navigation">
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')">
          Overview
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'members'"
          (click)="setActiveTab('members')">
          Members ({{ mgrDetails.memberCount }})
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'contributions'"
          (click)="setActiveTab('contributions')">
          Contributions
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'settings'"
          (click)="setActiveTab('settings')">
          Settings
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'notes'"
          (click)="setActiveTab('notes')">
          Admin Notes
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        @if (activeTab === 'overview') {
          <div class="overview-content">
            <!-- Basic Info -->
            <div class="info-section">
              <h3>Basic Information</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label>Description</label>
                  <p>{{ mgrDetails.description }}</p>
                </div>
                <div class="info-item">
                  <label>Category</label>
                  <span class="category-badge">{{ mgrDetails.category }}</span>
                </div>
                <div class="info-item">
                  <label>Creator</label>
                  <div class="creator-info">
                    <strong>{{ mgrDetails.creator.name }}</strong>
                    <small>{{ mgrDetails.creator.email }}</small>
                  </div>
                </div>
                <div class="info-item">
                  <label>Created</label>
                  <p>{{ formatDate(mgrDetails.createdAt) }}</p>
                </div>
              </div>
            </div>

            <!-- Statistics -->
            <div class="stats-section">
              <h3>Statistics</h3>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-value">{{ mgrDetails.statistics.successRate }}%</div>
                  <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">{{ formatCurrency(mgrDetails.statistics.averageContribution) }}</div>
                  <div class="stat-label">Avg Contribution</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">{{ formatCurrency(mgrDetails.statistics.totalDisbursed) }}</div>
                  <div class="stat-label">Total Disbursed</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">{{ mgrDetails.statistics.completedCycles }}</div>
                  <div class="stat-label">Completed Cycles</div>
                </div>
              </div>
            </div>

            <!-- Progress -->
            <div class="progress-section">
              <h3>Progress</h3>
              <div class="progress-info">
                <div class="progress-details">
                  <span>{{ mgrDetails.memberCount }} / {{ mgrDetails.maxMembers }} Members</span>
                  <span>{{ mgrDetails.progress }}% Complete</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="mgrDetails.progress"></div>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Members Tab -->
        @if (activeTab === 'members') {
          <div class="members-content">
            <div class="members-list">
              @for (member of mgrDetails.members; track member.id) {
                <div class="member-card">
                  <div class="member-info">
                    <div class="member-header">
                      <h4>{{ member.name }}</h4>
                      <span class="status-badge" [class]="getStatusBadgeClass(member.status)">
                        {{ member.status | titlecase }}
                      </span>
                    </div>
                    <div class="member-details">
                      <div class="detail-item">
                        <label>Email:</label>
                        <span>{{ member.email }}</span>
                      </div>
                      <div class="detail-item">
                        <label>Phone:</label>
                        <span>{{ member.phone }}</span>
                      </div>
                      <div class="detail-item">
                        <label>Position:</label>
                        <span>#{{ member.position }}</span>
                      </div>
                      <div class="detail-item">
                        <label>Joined:</label>
                        <span>{{ formatDate(member.joinedAt) }}</span>
                      </div>
                      <div class="detail-item">
                        <label>Credit Score:</label>
                        <span class="credit-score" [class]="getMemberScoreClass(member.creditScore)">
                          {{ member.creditScore }}
                        </span>
                      </div>
                      <div class="detail-item">
                        <label>Total Contributions:</label>
                        <span>{{ formatCurrency(member.totalContributions) }}</span>
                      </div>
                      <div class="detail-item">
                        <label>Missed Payments:</label>
                        <span class="missed-payments" [class.warning]="member.missedPayments > 0">
                          {{ member.missedPayments }}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="member-actions">
                    @if (member.status === 'active') {
                      <button class="btn btn-sm btn-warning" (click)="openMemberModal(member, 'suspended')">
                        Suspend
                      </button>
                    }
                    @if (member.status === 'suspended') {
                      <button class="btn btn-sm btn-success" (click)="openMemberModal(member, 'active')">
                        Resume
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Contributions Tab -->
        @if (activeTab === 'contributions') {
          <div class="contributions-content">
            <div class="contributions-list">
              @for (contribution of mgrDetails.contributions; track contribution.id) {
                <div class="contribution-item">
                  <div class="contribution-info">
                    <div class="contribution-header">
                      <strong>{{ contribution.memberName }}</strong>
                      <span class="contribution-amount">{{ formatCurrency(contribution.amount) }}</span>
                    </div>
                    <div class="contribution-details">
                      <span>{{ formatDate(contribution.date) }}</span>
                      <span class="status-badge" [class]="getContributionStatusClass(contribution.status)">
                        {{ contribution.status | titlecase }}
                      </span>
                      <span>{{ contribution.paymentMethod }}</span>
                      <span>Cycle {{ contribution.cycle }}</span>
                    </div>
                    @if (contribution.notes) {
                      <div class="contribution-notes">{{ contribution.notes }}</div>
                    }
                  </div>
                  <div class="contribution-ref">
                    <small>Ref: {{ contribution.transactionRef }}</small>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Settings Tab -->
        @if (activeTab === 'settings') {
          <div class="settings-content">
            <div class="settings-section">
              <h3>MGR Settings</h3>
              <div class="settings-grid">
                <div class="setting-item">
                  <label>Auto Approve Members</label>
                  <span class="setting-value" [class.enabled]="mgrDetails.settings.autoApprove">
                    {{ mgrDetails.settings.autoApprove ? 'Enabled' : 'Disabled' }}
                  </span>
                </div>
                <div class="setting-item">
                  <label>Requires KYC</label>
                  <span class="setting-value" [class.enabled]="mgrDetails.settings.requiresKyc">
                    {{ mgrDetails.settings.requiresKyc ? 'Required' : 'Not Required' }}
                  </span>
                </div>
                <div class="setting-item">
                  <label>Minimum Credit Score</label>
                  <span class="setting-value">{{ mgrDetails.settings.minimumCreditscore }}</span>
                </div>
                <div class="setting-item">
                  <label>Early Withdrawal</label>
                  <span class="setting-value" [class.enabled]="mgrDetails.settings.allowEarlyWithdrawal">
                    {{ mgrDetails.settings.allowEarlyWithdrawal ? 'Allowed' : 'Not Allowed' }}
                  </span>
                </div>
                <div class="setting-item">
                  <label>Penalty Rate</label>
                  <span class="setting-value">{{ mgrDetails.settings.penaltyRate }}%</span>
                </div>
              </div>
            </div>

            <div class="schedule-section">
              <h3>Schedule Information</h3>
              <div class="schedule-grid">
                <div class="schedule-item">
                  <label>Contribution Amount</label>
                  <span>{{ formatCurrency(mgrDetails.contributionAmount) }}</span>
                </div>
                <div class="schedule-item">
                  <label>Frequency</label>
                  <span>{{ mgrDetails.contributionFrequency | titlecase }}</span>
                </div>
                <div class="schedule-item">
                  <label>Start Date</label>
                  <span>{{ formatDate(mgrDetails.startDate) }}</span>
                </div>
                @if (mgrDetails.endDate) {
                  <div class="schedule-item">
                    <label>End Date</label>
                    <span>{{ formatDate(mgrDetails.endDate) }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Admin Notes Tab -->
        @if (activeTab === 'notes') {
          <div class="notes-content">
            <div class="notes-list">
              @for (note of mgrDetails.adminNotes; track note.id) {
                <div class="note-item">
                  <div class="note-header">
                    <div class="note-author">
                      <strong>{{ note.adminName }}</strong>
                      <span class="note-type" [class]="'note-' + note.type">{{ note.type | titlecase }}</span>
                    </div>
                    <span class="note-date">{{ formatDate(note.createdAt) }}</span>
                  </div>
                  <div class="note-content">{{ note.note }}</div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Status Update Modal -->
    @if (showStatusModal) {
      <div class="modal-overlay" (click)="resetModals()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Update MGR Status</h3>
            <button class="close-button" (click)="resetModals()">×</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to {{ statusAction }} this MGR?</p>
            <div class="form-group">
              <label for="adminNote">Admin Note (Optional)</label>
              <textarea 
                id="adminNote"
                [(ngModel)]="adminNote" 
                placeholder="Add a note about this action..."
                rows="3">
              </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="resetModals()">Cancel</button>
            <button class="btn btn-primary" (click)="confirmStatusUpdate()">Confirm</button>
          </div>
        </div>
      </div>
    }

    <!-- Add Note Modal -->
    @if (showNoteModal) {
      <div class="modal-overlay" (click)="resetModals()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Add Admin Note</h3>
            <button class="close-button" (click)="resetModals()">×</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="noteText">Note</label>
              <textarea 
                id="noteText"
                [(ngModel)]="adminNote" 
                placeholder="Enter your note..."
                rows="4"
                required>
              </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="resetModals()">Cancel</button>
            <button class="btn btn-primary" (click)="addAdminNote()" [disabled]="!adminNote">Add Note</button>
          </div>
        </div>
      </div>
    }

    <!-- Member Action Modal -->
    @if (showMemberModal && selectedMember) {
      <div class="modal-overlay" (click)="resetModals()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>{{ memberAction | titlecase }} Member</h3>
            <button class="close-button" (click)="resetModals()">×</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to {{ memberAction }} <strong>{{ selectedMember.name }}</strong>?</p>
            <div class="form-group">
              <label for="memberNote">Reason (Optional)</label>
              <textarea 
                id="memberNote"
                [(ngModel)]="memberNote" 
                placeholder="Enter reason for this action..."
                rows="3">
              </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="resetModals()">Cancel</button>
            <button class="btn btn-primary" (click)="updateMemberStatus()">Confirm</button>
          </div>
        </div>
      </div>
    }
  </div>
</div> 